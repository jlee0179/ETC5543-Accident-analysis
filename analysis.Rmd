---
title: "analysis"
author: "Joyce Lee"
date: "03/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(lubridate)
library(tidyverse)
```

### Data wrangling

```{r}
driver_info <- read_csv("data/Driver_Info.csv") %>%
  filter(!Depot == "Not Given")
incidents <- read_csv("data/Incidents.csv")
nswshifts <- read_csv("data/NSWshifts.csv") %>%
  distinct()
melbourneweather <- read_csv("data/melbourneweather_20150101_20210428.csv")
sydneyweather <- read_csv("data/sydneyweather_20150101_20210415.csv")
```

```{r}
incidents <- incidents %>%
  unite(EmployeeID, c("company", "EmployeeNumber"), remove = FALSE)
```

```{r}
nswshifts$VdsCompany <- toupper(nswshifts$VdsCompany)
nswshifts <- nswshifts %>%
  unite(EmployeeID, c("VdsCompany", "VdsEmployeeId"), remove = FALSE)


tmp <- incidents %>%
  filter(company == 'TDNSW') %>%
  select(ClaimNumber, EmployeeID, ClaimCategoryName, TypeOfClaimName, DateOccurred) %>%
  mutate(JoinDate = as.Date(DateOccurred)) %>%
  left_join(nswshifts %>%
              mutate(JoinDate = as.Date(VdsTripStartTime)),
            by = c("EmployeeID","JoinDate")) %>%
  mutate(match_type = case_when(
    is.na(VdsTripStartTime) ~ 0,
    DateOccurred >= VdsTripStartTime & DateOccurred <= VdsTripEndTime ~ 2,
    TRUE ~ 1
  ))
matched <-
  tmp %>%
  inner_join(
    tmp %>% group_by(ClaimNumber) %>% summarise(match_type = max(match_type)),
    by = c("ClaimNumber", "match_type")
  ) %>%
  arrange(match_type,ClaimNumber,VdsTripStartTime)

tmp2 <- incidents %>%
  filter(company == 'TDNSW') %>%
  select(ClaimNumber, EmployeeID, ClaimCategoryName, TypeOfClaimName,DateOccurred) %>%
  mutate(JoinDate = as.Date(DateOccurred)) %>%
  left_join(nswshifts %>%
              mutate(JoinDate = as.Date(VdsTripStartTime)) %>%
              group_by(EmployeeID, JoinDate) %>%
              summarise(shift_start = min(VdsTripStartTime)-30*60,
                        shift_end = max(VdsTripEndTime)+30*60),
            by = c("EmployeeID","JoinDate")) %>%
  mutate(match_type = case_when(
    is.na(shift_start) ~ 0,
    DateOccurred >= shift_start & DateOccurred <= shift_end ~ 2,
    TRUE ~ 1
  ))
matched <-
  tmp2 %>%
  inner_join(
    tmp2 %>% group_by(ClaimNumber) %>% summarise(match_type = max(match_type)),
    by = c("ClaimNumber", "match_type")
  ) %>%
  arrange(match_type,ClaimNumber,shift_start)

tmp <- tmp %>%
  mutate(day_of_week = weekdays(as.Date(DateOccurred)))

tmp2 <- tmp2 %>%
  mutate(day_of_week = weekdays(as.Date(DateOccurred)))
```

```{r}
melbourneweather <- melbourneweather %>%
  slice(-1:-9) %>%
  select(location, Melbourne, Melbourne_1) %>%
  rename(c(timestamp = location, `Melbourne Temperature` = Melbourne, `Melbourne Precipitation Total` = Melbourne_1)) 
melbourneweather <- melbourneweather %>%
        mutate(timestamp = ymd_hm(timestamp))

```

```{r}
sydneyweather <- sydneyweather %>%
  slice(-1:-9) %>%
  select(location, Sydney, Sydney_1) %>%
  rename(c(timestamp = location, `Sydney Temperature` = Sydney, `Sydney Precipitation Total` = Sydney_1)) 
sydneyweather <- sydneyweather %>%
        mutate(timestamp = ymd_hm(timestamp))
```

### Questions:
1. How are drivers' characteristics (Depot, gender and age) affecting the incidents? Which is contributing the most incidents?

```{r}
incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  inner_join(driver_info, by = "EmployeeID") %>%
  group_by(Depot, company) %>%
  summarise(total_cases_num = n()) %>%
  ggplot(aes(x = Depot, y = total_cases_num, fill = company)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = total_cases_num)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Total claim number", title = "Total claim by depot")
```


```{r}
# all drivers in each depot
total_drvr_inc <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  right_join(driver_info, by = "EmployeeID") %>%
  group_by(Depot, CompanyID, EmployeeID) %>%
  mutate(driver_incident = case_when(is.na(ClaimNumber) ~ "No",
                                         !is.na(ClaimNumber) ~ "Yes")) %>%
  group_by(Depot, CompanyID, driver_incident, EmployeeID) %>%
  summarise(driver_depot = n_distinct(EmployeeID)) %>%
  filter(driver_incident == "Yes") %>%
  group_by(Depot, CompanyID) %>%
  summarise(num_drv_inc = sum(driver_depot))

total_drvr_dpt <- driver_info %>%
  group_by(Depot, CompanyID) %>%
  summarise(num_of_drvr = n())

total_drvr_inc %>%
  left_join(total_drvr_dpt, by = c("Depot", "CompanyID")) %>%
  mutate(has_incident_dpt = (num_drv_inc/num_of_drvr)*100) %>%
  mutate(across(has_incident_dpt, round, 2)) %>%
  ggplot(aes(x = Depot, y = has_incident_dpt, fill = CompanyID)) +
  geom_bar(stat = "identity") + 
  geom_text(aes(label = has_incident_dpt), vjust=1.6, color="white", size=2.5) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y = "Drivers having incidents", fill = "Company", title = "Proportion of drivers having incidents by Depot")


```

### Gender

```{r}
incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  inner_join(driver_info, by = "EmployeeID") %>%
  group_by(Gender, company) %>%
  summarise(total_cases_num = n()) %>%
  ggplot(aes(x = Gender, y = total_cases_num, fill = Gender)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = total_cases_num)) +
  theme_minimal() +
  facet_wrap(~company) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Total claim number", title = "Total claim by gender and State")
```

### Age

```{r}
age_incidents <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  inner_join(driver_info, by = "EmployeeID") %>%
  mutate(driver_age = today() - dmy(BirthDate),
         driver_age = driver_age/dyears()) 
age_incidents$driver_age <- round(age_incidents$driver_age, digits = 0)
age_incidents <- age_incidents %>%
  mutate(age_group = case_when(driver_age >= 21 & driver_age <= 30 ~ "21-30",
                               driver_age >= 31 & driver_age <= 40 ~ "31-40",
                               driver_age >= 41 & driver_age <= 50 ~ "41-50",
                               driver_age >= 51 & driver_age <= 60 ~ "51-60",
                               driver_age >= 61 & driver_age <= 70 ~ "61-70",
                               driver_age >= 71 & driver_age <= 80 ~ "71-80",
                               driver_age >= 81 & driver_age <= 90 ~ "81-90"))
age_incidents %>%
  group_by(age_group) %>%
  summarise(total_cases_num = n()) %>%
  ggplot(aes(x = age_group, y = total_cases_num, fill = age_group)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = total_cases_num)) +
  theme_minimal() +
  labs(x = "Age group", y = "Total claim number", title = "Total claim by age group", fill = "Age group")
  
```

2. On what day have most incidents been found? Which hours are the peak and trough?

```{r}
incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  mutate(day_week = weekdays(as.Date(DateOccurred))) %>%
  group_by(day_week) %>%
  summarise(total_cases = n()) %>%
  ggplot(aes(x = factor(day_week, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")), total_cases)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_text(aes(label=total_cases), vjust=1.6, color="white", size=3.5)+
    theme_minimal() +
  labs(y = "Total claim number", x = "Day", title = "Total claim by day of the week")
```

```{r}
incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  mutate(day_week = weekdays(DateOccurred),
         hour = hour(DateOccurred)) %>%
  group_by(day_week, hour) %>%
  summarise(total_cases = n()) %>%
  ggplot(aes(x = hour, y = total_cases)) +
  geom_line() +
  facet_wrap(~factor(day_week, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) +
    theme_minimal() +
  labs(y = "Total claim number", x = "Hour", title = "Total claim by daily hours")

```

3. Has daytime or night been a significant cause of incidents?

```{r}
daynight_incidents <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  mutate(hour = hour(DateOccurred))

daynight_incidents %>%
  mutate(day_night = case_when(hour >= 19 | hour %in% c(0, 1, 2, 3, 4) ~ "night",
                               hour < 19 ~ "day")) %>%
  group_by(day_night) %>%
  summarise(total_cases = n()) %>%
  ggplot(aes(x = day_night, y = total_cases, fill = day_night)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=total_cases), vjust=1.6, color="white", size=3.5) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "Daytime/night", y = "Total claim number")
```

```{r}
tmp2 %>%
  filter(match_type == 2) %>%
  
  
```

4. What kind of weather (temperature and precipitation) is considered safer or dangerous for bus drivers?

```{r}
dh_incidents <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  mutate(date_hour = format(DateOccurred, format = "%Y-%m-%d %H"))

melbourneweather <- melbourneweather %>%
  mutate(company = "TDM",
         date_hour = format(timestamp, format = "%Y-%m-%d %H")) %>%
  rename(Temperature = `Melbourne Temperature`, Precipitation = `Melbourne Precipitation Total`)

sydneyweather <- sydneyweather %>%
  mutate(company = "TDM",
         date_hour = format(timestamp, format = "%Y-%m-%d %H")) %>%
  rename(Temperature = `Sydney Temperature`, Precipitation = `Sydney Precipitation Total`)

mel_syd_weather <- rbind(melbourneweather, sydneyweather)

weather_incidents <- dh_incidents %>%
  inner_join(mel_syd_weather, by = c("company", "date_hour")) 

weather_incidents %>%
  mutate(date = format(timestamp, format = "%Y-%m-%d")) %>%
  group_by(Temperature) %>%
  summarise(count = n()) 


    high_prcp = if_else(condition = Precipitation > 5,
                          true = "rain",
                          false = "none"),
    high_temp = if_else(condition = Temperature > 33,
                        true = "hot",
                        false = "not"),
    low_temp = if_else(condition = Temperature < 6,
                        true = "cold",
                        false = "not"))


```

5. Is there a relationship between drivers' driving hours within a day and the likelihood of getting into an incident?

```{r}
tmp2 %>%
  filter(match_type == 2) %>%
  mutate(i_driving_hour = )
```

