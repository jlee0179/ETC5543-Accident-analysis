---
title: "analysis"
author: "Joyce Lee"
date: "03/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(lubridate)
library(tidyverse)
```

### Data wrangling

```{r}
driver_info <- read_csv("data/Driver_Info.csv")
incidents <- read_csv("data/Incidents.csv")
nswshifts <- read_csv("data/NSWshifts.csv") %>%
  distinct()
melbourneweather <- read_csv("data/melbourneweather_20150101_20210428.csv")
sydneyweather <- read_csv("data/sydneyweather_20150101_20210415.csv")
```

```{r}
incidents <- incidents %>%
  unite(EmployeeID, c("company", "EmployeeNumber"), remove = FALSE)
```

```{r}
nswshifts$VdsCompany <- toupper(nswshifts$VdsCompany)
nswshifts <- nswshifts %>%
  unite(EmployeeID, c("VdsCompany", "VdsEmployeeId"), remove = FALSE)


tmp <- incidents %>%
  filter(company == 'TDNSW') %>%
  select(ClaimNumber, EmployeeID,TypeOfClaimName,DateOccurred) %>%
  mutate(JoinDate = as.Date(DateOccurred)) %>%
  left_join(nswshifts %>%
              mutate(JoinDate = as.Date(VdsTripStartTime)),
            by = c("EmployeeID","JoinDate")) %>%
  mutate(match_type = case_when(
    is.na(VdsTripStartTime) ~ 0,
    DateOccurred >= VdsTripStartTime & DateOccurred <= VdsTripEndTime ~ 2,
    TRUE ~ 1
  ))
matched <-
  tmp %>%
  inner_join(
    tmp %>% group_by(ClaimNumber) %>% summarise(match_type = max(match_type)),
    by = c("ClaimNumber", "match_type")
  ) %>%
  arrange(match_type,ClaimNumber,VdsTripStartTime)

tmp2 <- incidents %>%
  filter(company == 'TDNSW') %>%
  select(ClaimNumber, EmployeeID,TypeOfClaimName,DateOccurred) %>%
  mutate(JoinDate = as.Date(DateOccurred)) %>%
  left_join(nswshifts %>%
              mutate(JoinDate = as.Date(VdsTripStartTime)) %>%
              group_by(EmployeeID, JoinDate) %>%
              summarise(shift_start = min(VdsTripStartTime)-30*60,
                        shift_end = max(VdsTripEndTime)+30*60),
            by = c("EmployeeID","JoinDate")) %>%
  mutate(match_type = case_when(
    is.na(shift_start) ~ 0,
    DateOccurred >= shift_start & DateOccurred <= shift_end ~ 2,
    TRUE ~ 1
  ))
matched <-
  tmp2 %>%
  inner_join(
    tmp2 %>% group_by(ClaimNumber) %>% summarise(match_type = max(match_type)),
    by = c("ClaimNumber", "match_type")
  ) %>%
  arrange(match_type,ClaimNumber,shift_start)

tmp <- tmp %>%
  mutate(day_of_week = weekdays(as.Date(DateOccurred)))

tmp2 <- tmp2 %>%
  mutate(day_of_week = weekdays(as.Date(DateOccurred)))
```

```{r}
melbourneweather <- melbourneweather %>%
  slice(-1:-9) %>%
  select(location, Melbourne, Melbourne_1) %>%
  rename(c(timestamp = location, `Melbourne Temperature` = Melbourne, `Melbourne Precipitation Total` = Melbourne_1)) 
melbourneweather <- melbourneweather %>%
        mutate(timestamp = ymd_hm(timestamp))

```

```{r}
sydneyweather <- sydneyweather %>%
  slice(-1:-9) %>%
  select(location, Sydney, Sydney_1) %>%
  rename(c(timestamp = location, `Sydney Temperature` = Sydney, `Sydney Precipitation Total` = Sydney_1)) 
sydneyweather <- sydneyweather %>%
        mutate(timestamp = ymd_hm(timestamp))
```

### Questions:
1. How are drivers' characteristics (Depot, gender, employee start date and age) affecting the incidents? Which is contributing the most incidents?

```{r}

```

2. On what day have most incidents been found? Which hours are the peak and trough?
3. Has daytime or night been a significant cause of incidents?
4. What kind of weather (temperature and precipitation) is considered safer or dangerous for bus drivers?
5. Is there a relationship between drivers' driving hours within a day and the likelihood of getting into an incident?