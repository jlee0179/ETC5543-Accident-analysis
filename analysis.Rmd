---
title: "analysis"
author: "Joyce Lee"
date: "03/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(caret)
library(ggridges)
library(hrbrthemes)
library(lubridate)
library(plotly)
library(randomForest)
library(tidyverse)
```

### Data wrangling

```{r}
driver_info <- read_csv("data/Driver_Info.csv") %>%
  filter(!Depot == "Not Given")
incidents <- read_csv("data/Incidents.csv")
nswshifts <- read_csv("data/NSWshifts.csv") %>%
  distinct()
melbourneweather <- read_csv("data/melbourneweather_20150101_20210428.csv")
sydneyweather <- read_csv("data/sydneyweather_20150101_20210415.csv")
```

```{r}
incidents <- incidents %>%
  unite(EmployeeID, c("company", "EmployeeNumber"), remove = FALSE)
```

```{r}
nswshifts$VdsCompany <- toupper(nswshifts$VdsCompany)
nswshifts <- nswshifts %>%
  unite(EmployeeID, c("VdsCompany", "VdsEmployeeId"), remove = FALSE)


tmp <- incidents %>%
  filter(company == 'TDNSW') %>%
  select(ClaimNumber, EmployeeID, ClaimCategoryName, TypeOfClaimName, DateOccurred) %>%
  mutate(JoinDate = as.Date(DateOccurred)) %>%
  left_join(nswshifts %>%
              mutate(JoinDate = as.Date(VdsTripStartTime)),
            by = c("EmployeeID","JoinDate")) %>%
  mutate(match_type = case_when(
    is.na(VdsTripStartTime) ~ 0,
    DateOccurred >= VdsTripStartTime & DateOccurred <= VdsTripEndTime ~ 2,
    TRUE ~ 1
  ))
matched <-
  tmp %>%
  inner_join(
    tmp %>% group_by(ClaimNumber) %>% summarise(match_type = max(match_type)),
    by = c("ClaimNumber", "match_type")
  ) %>%
  arrange(match_type,ClaimNumber,VdsTripStartTime)

tmp2 <- incidents %>%
  filter(company == 'TDNSW') %>%
  select(ClaimNumber, EmployeeID, ClaimCategoryName, TypeOfClaimName,DateOccurred) %>%
  mutate(JoinDate = as.Date(DateOccurred)) %>%
  left_join(nswshifts %>%
              mutate(JoinDate = as.Date(VdsTripStartTime)) %>%
              group_by(EmployeeID, JoinDate) %>%
              summarise(shift_start = min(VdsTripStartTime)-30*60,
                        shift_end = max(VdsTripEndTime)+30*60),
            by = c("EmployeeID","JoinDate")) %>%
  mutate(match_type = case_when(
    is.na(shift_start) ~ 0,
    DateOccurred >= shift_start & DateOccurred <= shift_end ~ 2,
    TRUE ~ 1
  ))
matched <-
  tmp2 %>%
  inner_join(
    tmp2 %>% group_by(ClaimNumber) %>% summarise(match_type = max(match_type)),
    by = c("ClaimNumber", "match_type")
  ) %>%
  arrange(match_type,ClaimNumber,shift_start)

tmp <- tmp %>%
  mutate(day_of_week = weekdays(as.Date(DateOccurred)))

tmp2 <- tmp2 %>%
  mutate(day_of_week = weekdays(as.Date(DateOccurred)))
```

```{r}
melbourneweather <- melbourneweather %>%
  slice(-1:-9) %>%
  select(location, Melbourne, Melbourne_1) %>%
  rename(c(timestamp = location, `Melbourne Temperature` = Melbourne, `Melbourne Precipitation Total` = Melbourne_1)) 
melbourneweather <- melbourneweather %>%
        mutate(timestamp = ymd_hm(timestamp))

```

```{r}
sydneyweather <- sydneyweather %>%
  slice(-1:-9) %>%
  select(location, Sydney, Sydney_1) %>%
  rename(c(timestamp = location, `Sydney Temperature` = Sydney, `Sydney Precipitation Total` = Sydney_1)) 
sydneyweather <- sydneyweather %>%
        mutate(timestamp = ymd_hm(timestamp))
```

### Questions:
1. How are drivers' characteristics (Depot, gender and age) affecting the incidents? Which is contributing the most incidents?



```{r}
# all drivers in each depot
drvr_inc_dpt <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  right_join(driver_info, by = "EmployeeID") %>%
  mutate(driver_incident = case_when(is.na(ClaimNumber) ~ "No",
                                         !is.na(ClaimNumber) ~ "Yes")) %>%
  group_by(Depot, CompanyID, driver_incident, EmployeeID) %>%
  summarise(driver_depot = n_distinct(EmployeeID)) %>%
  filter(driver_incident == "Yes") %>%
  group_by(Depot, CompanyID) %>%
  summarise(num_drv_inc = sum(driver_depot))

total_drvr_dpt <- driver_info %>%
  group_by(Depot, CompanyID) %>%
  summarise(num_of_drvr = n())

drvr_inc_dpt %>%
  left_join(total_drvr_dpt, by = c("Depot", "CompanyID")) %>%
  mutate(has_incident_dpt = (num_drv_inc/num_of_drvr)*100) %>%
  mutate(across(has_incident_dpt, round, 2)) %>%
  ggplot(aes(x = Depot, y = has_incident_dpt, fill = CompanyID)) +
  geom_bar(stat = "identity") + 
  geom_text(aes(label = has_incident_dpt), vjust=1.6, color="white", size=2.5) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y = "Drivers had claims", fill = "Company", title = "Proportion of drivers had claims by Depot")


```

```{r}
severity_inc <- incidents %>%
  mutate(severity = case_when(TypeOfClaimName %in% c("MVA - Hit by Third Party", "MVA - Hit parked vehicle", "Customer Injury- Heavy Braking", "MVA - Hit moving vehicle while driving straight", "MVA - Hit moving vehicle while turning", "MVA - Hit stationary vehicle while turning", "MVA - Hit stationary vehicle driving straight", "MVA - Hit illegally parked vehicle", "MVA - Hit moving vehicle while changing lanes", "Pedestrian Injury - Hit by Transdev vehicle", "MVA - Hit bus station", "Employee Injury - Motor Vehicle Accident", "Motor Vehicle Collision", "Collision with Public") ~ "serious",
                              TypeOfClaimName %in% c("MVA - Hit tree/ tree branch", "MVA - Hit barrier/ bollard", "MVA - Near Miss", "MVA - Reversing", "MVA bus stop sign", "MVA bus stop pole") ~ "slight")) %>%
  filter(severity %in% c("serious", "slight"))

inc_severity_dept <- severity_inc %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  right_join(driver_info, by = "EmployeeID") %>%
  mutate(driver_incident = case_when(is.na(ClaimNumber) ~ "No",
                                         !is.na(ClaimNumber) ~ "Yes")) %>%
  group_by(Depot, CompanyID, driver_incident, EmployeeID, severity) %>%
  summarise(driver_depot = n_distinct(EmployeeID)) %>%
  filter(driver_incident == "Yes") %>%
  group_by(Depot, severity, CompanyID) %>%
  summarise(num_drv_inc = sum(driver_depot))
  
total_drvr_dpt <- driver_info %>%
  group_by(Depot, CompanyID) %>%
  summarise(num_of_drvr = n())

svr_dpt <- inc_severity_dept %>%
  left_join(total_drvr_dpt, by = c("Depot", "CompanyID")) %>%
  mutate(has_incident_dpt = (num_drv_inc/num_of_drvr)*100) %>%
  mutate(across(has_incident_dpt, round, 2)) %>%
  pivot_wider(names_from = severity, values_from = has_incident_dpt) %>%
  mutate(serious = replace_na(serious, 0),
         slight = replace_na(slight, 0))

svr_dpt %>%
  mutate(serious_label = paste0(CompanyID," - Serious"),
         slight_label = paste0(CompanyID," - Slight")) %>%
  plot_ly(x = ~Depot, color = ~CompanyID) %>%
  add_trace(y = ~serious, name = ~serious_label, type='bar',width = 0.3) %>%
  add_trace(y = ~slight, name = ~slight_label, type='bar', width=0.3,opacity=0.5) %>%
  layout(
    title = "Proportion of drivers had claims by Depot and Severity",
    yaxis = list(title = "Drivers had claims (%)",
                 range=c(0,100)),
    updatemenus = list(
      list(
        type = "buttons",
        #label = 'Category',
        buttons = list(
          list(method = "restyle",
               args = list('visible', c(rep(TRUE,3), rep(FALSE,3))),
               label = "Serious Only"),
          list(method = "restyle",
               args = list('visible', c(rep(FALSE,3), rep(TRUE,3))),
               label = "Slight Only"),
          list(method = "restyle",
               args = list('visible', TRUE),
               label = "Show All")
        )
      )
    )
  )
```

### Gender


```{r}
drvr_inc_gdr <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  right_join(driver_info, by = "EmployeeID") %>%
  mutate(driver_incident = case_when(is.na(ClaimNumber) ~ "No",
                                         !is.na(ClaimNumber) ~ "Yes")) %>%
  group_by(Gender, CompanyID, driver_incident, EmployeeID) %>%
  summarise(driver_gdr = n_distinct(EmployeeID)) %>%
  filter(driver_incident == "Yes") %>%
  group_by(Gender, CompanyID) %>%
  summarise(num_drv_inc = sum(driver_gdr))

total_drvr_gdr <- driver_info %>%
  group_by(Gender, CompanyID) %>%
  summarise(num_of_drvr = n())

drvr_inc_gdr %>%
  full_join(total_drvr_gdr, by = c("Gender", "CompanyID")) %>%
  mutate(num_drv_inc = replace_na(num_drv_inc, 0)) %>%
  mutate(has_incident_gdr = (num_drv_inc/num_of_drvr)*100) %>%
  mutate(across(has_incident_gdr, round, 2)) %>%
  ggplot(aes(x = Gender, y = has_incident_gdr, fill = Gender)) +
  geom_bar(stat = "identity") + 
  geom_text(aes(label = has_incident_gdr), vjust=1.6, color="white", size=2.5) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal() +
  facet_grid(.~CompanyID) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(y = "Drivers had claims", fill = "Gender", title = "Proportion of drivers had claims by Gender and company")
  
```

```{r}
inc_severity_gdr <- severity_inc %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  right_join(driver_info, by = "EmployeeID") %>%
  mutate(driver_incident = case_when(is.na(ClaimNumber) ~ "No",
                                         !is.na(ClaimNumber) ~ "Yes")) %>%
  group_by(Gender, CompanyID, driver_incident, EmployeeID, severity) %>%
  summarise(driver_depot = n_distinct(EmployeeID)) %>%
  filter(driver_incident == "Yes") %>%
  group_by(Gender, severity, CompanyID) %>%
  summarise(num_drv_inc = sum(driver_depot))
  
total_drvr_gdr <- driver_info %>%
  group_by(Gender, CompanyID) %>%
  summarise(num_of_drvr = n())

svr_gdr <- inc_severity_gdr %>%
  left_join(total_drvr_gdr, by = c("Gender", "CompanyID")) %>%
  mutate(has_incident_gdr = (num_drv_inc/num_of_drvr)*100) %>%
  mutate(across(has_incident_gdr, round, 2)) %>%
  pivot_wider(names_from = severity, values_from = has_incident_gdr) %>%
  mutate(serious = replace_na(serious, 0),
         slight = replace_na(slight, 0))

svr_gdr %>%
  mutate(serious_label = paste0(CompanyID," - Serious"),
         slight_label = paste0(CompanyID," - Slight")) %>%
  plot_ly(x = ~Gender, color = ~CompanyID) %>%
  add_trace(y = ~serious, name = ~serious_label, type='bar') %>%
  add_trace(y = ~slight, name = ~slight_label, type='bar',opacity=0.5)  %>%
  layout(
    yaxis = list(title = "Drivers had claims (%)",
      range=c(0,100)
    ),
    title = "Proportion of drivers had claims by Gender and Severity",
    updatemenus = list(
      list(
        type = "buttons",
        label = 'Category',
        buttons = list(
          list(method = "restyle",
               args = list('visible', c(rep(TRUE,3), rep(FALSE,3))),
               label = "Serious Only"),
          list(method = "restyle",
               args = list('visible', c(rep(FALSE,3), rep(TRUE,3))),
               label = "Slight Only"),
          list(method = "restyle",
               args = list('visible', TRUE),
               label = "Show All")
        )
      )
    )
  )
```



### Age

```{r}
inc_age <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  right_join(driver_info, by = "EmployeeID") %>%
  mutate(driver_age = today() - dmy(BirthDate),
         driver_age = driver_age/dyears(),
         driver_incident = case_when(is.na(ClaimNumber) ~ "No",
                                         !is.na(ClaimNumber) ~ "Yes"))
inc_age$driver_age <- round(inc_age$driver_age, digits = 0)
inc_age <- inc_age %>%
  mutate(age_group = case_when(driver_age >= 20 & driver_age <= 30 ~ "20-30",
                               driver_age >= 31 & driver_age <= 40 ~ "31-40",
                               driver_age >= 41 & driver_age <= 50 ~ "41-50",
                               driver_age >= 51 & driver_age <= 60 ~ "51-60",
                               driver_age >= 61 & driver_age <= 70 ~ "61-70",
                               driver_age >= 71 & driver_age <= 80 ~ "71-80",
                               driver_age >= 81 & driver_age <= 90 ~ "81-90"))
inc_age <- inc_age %>%
  group_by(age_group, driver_incident, EmployeeID) %>%
  summarise(driver_age_group = n_distinct(EmployeeID)) %>%
  filter(driver_incident == "Yes") %>%
  group_by(age_group) %>%
  summarise(num_drv_inc = sum(driver_age_group))


drvr_info_age <- driver_info %>%
  mutate(driver_age = today() - dmy(BirthDate),
         driver_age = driver_age/dyears())
drvr_info_age$driver_age <- round(drvr_info_age$driver_age, digits = 0)
drvr_info_age <- drvr_info_age %>%
  mutate(age_group = case_when(driver_age >= 20 & driver_age <= 30 ~ "20-30",
                               driver_age >= 31 & driver_age <= 40 ~ "31-40",
                               driver_age >= 41 & driver_age <= 50 ~ "41-50",
                               driver_age >= 51 & driver_age <= 60 ~ "51-60",
                               driver_age >= 61 & driver_age <= 70 ~ "61-70",
                               driver_age >= 71 & driver_age <= 80 ~ "71-80",
                               driver_age >= 81 & driver_age <= 90 ~ "81-90"))
drvr_info_age <- drvr_info_age %>%
  group_by(age_group) %>%
  summarise(num_of_drvr = n())

inc_age %>%
  full_join(drvr_info_age, by = "age_group") %>%
  mutate(has_incident_age = (num_drv_inc/num_of_drvr)*100) %>%
  mutate(across(has_incident_age, round, 2)) %>%
  ggplot(aes(x = age_group, y = has_incident_age, fill = age_group)) +
  geom_bar(stat = "identity") + 
  geom_text(aes(label = has_incident_age), vjust=1.6, color="white", size=2.5) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Age group", y = "Drivers had claims", fill = "Age group", title = "Proportion of drivers had claims by Age")
```

```{r}
inc_severity_age <- severity_inc %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  right_join(driver_info, by = "EmployeeID") %>%
  mutate(driver_age = today() - dmy(BirthDate),
         driver_age = driver_age/dyears(),
         driver_incident = case_when(is.na(ClaimNumber) ~ "No",
                                         !is.na(ClaimNumber) ~ "Yes")) 

inc_severity_age$driver_age <- round(inc_severity_age$driver_age, digits = 0)
inc_severity_age <- inc_severity_age %>%
  mutate(age_group = case_when(driver_age >= 20 & driver_age <= 30 ~ "20-30",
                               driver_age >= 31 & driver_age <= 40 ~ "31-40",
                               driver_age >= 41 & driver_age <= 50 ~ "41-50",
                               driver_age >= 51 & driver_age <= 60 ~ "51-60",
                               driver_age >= 61 & driver_age <= 70 ~ "61-70",
                               driver_age >= 71 & driver_age <= 80 ~ "71-80",
                               driver_age >= 81 & driver_age <= 90 ~ "81-90"))

inc_severity_age <- inc_severity_age %>%
  group_by(age_group, driver_incident, EmployeeID, severity) %>%
  summarise(driver_age_group = n_distinct(EmployeeID)) %>%
  filter(driver_incident == "Yes") %>%
  group_by(age_group, severity) %>%
  summarise(num_drv_inc = sum(driver_age_group))
  
drvr_info_age <- driver_info %>%
  mutate(driver_age = today() - dmy(BirthDate),
         driver_age = driver_age/dyears())
drvr_info_age$driver_age <- round(drvr_info_age$driver_age, digits = 0)
drvr_info_age <- drvr_info_age %>%
  mutate(age_group = case_when(driver_age >= 20 & driver_age <= 30 ~ "20-30",
                               driver_age >= 31 & driver_age <= 40 ~ "31-40",
                               driver_age >= 41 & driver_age <= 50 ~ "41-50",
                               driver_age >= 51 & driver_age <= 60 ~ "51-60",
                               driver_age >= 61 & driver_age <= 70 ~ "61-70",
                               driver_age >= 71 & driver_age <= 80 ~ "71-80",
                               driver_age >= 81 & driver_age <= 90 ~ "81-90"))
drvr_info_age <- drvr_info_age %>%
  group_by(age_group) %>%
  summarise(num_of_drvr = n())

svr_age <- inc_severity_age %>%
  full_join(drvr_info_age, by = "age_group") %>%
  mutate(has_incident_age = (num_drv_inc/num_of_drvr)*100) %>%
  mutate(across(has_incident_age, round, 2)) %>%
  pivot_wider(names_from = severity, values_from = has_incident_age) %>%
  mutate(serious = replace_na(serious, 0),
         slight = replace_na(slight, 0))

plot_ly(svr_age, x = ~age_group, mode='markers') %>%
  add_trace(y = ~serious, name = 'serious', type='bar', mode='markers') %>%
  add_trace(y = ~slight, name = 'slight', type='bar', mode='markers') %>%
  layout(
    title = "Proportion of drivers had claims by Age group and Severity",
    xaxis = list(title = "Age group"),
    yaxis = list(title = "Drivers had claims (%)",
                 range=c(0,100)),
    updatemenus = list(
      list(
        type = "buttons",
        label = 'Category',
        buttons = list(
          list(method = "restyle",
               args = list('visible', c(TRUE, FALSE, FALSE)),
               label = "Serious Only"),
          list(method = "restyle",
               args = list('visible', c(FALSE, TRUE, FALSE)),
               label = "Slight Only"),
          list(method = "restyle",
               args = list("visible", TRUE),
               label = "Show All")
        )
      )
    )
  )


```

2. On what day have most incidents been found? Which hours are the peak and trough?

```{r}
incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  mutate(day_week = weekdays(as.Date(DateOccurred))) %>%
  group_by(day_week) %>%
  summarise(total_cases = n()) %>%
  ggplot(aes(x = factor(day_week, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")), total_cases)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_text(aes(label=total_cases), vjust=1.6, color="white", size=3.5)+
    theme_minimal() +
  labs(y = "Total claim number", x = "Day", title = "Total claim by day of the week")
```

```{r}
incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  mutate(day_week = weekdays(DateOccurred),
         hour = hour(DateOccurred)) %>%
  group_by(day_week, hour) %>%
  summarise(total_cases = n()) %>%
  ggplot(aes(x = hour, y = total_cases)) +
  geom_line() +
  facet_wrap(~factor(day_week, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) +
    theme_minimal() +
  labs(y = "Total claim number", x = "Hour", title = "Total claim by daily hours")

```

3. Has daytime or night been a significant cause of incidents?

```{r}
daynight_incidents <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  mutate(hour = hour(DateOccurred))

daynight_incidents %>%
  mutate(day_night = case_when(hour >= 19 | hour %in% c(0, 1, 2, 3, 4) ~ "night",
                               hour < 19 ~ "day")) %>%
  group_by(day_night) %>%
  summarise(total_cases = n()) %>%
  ggplot(aes(x = day_night, y = total_cases, fill = day_night)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=total_cases), vjust=1.6, color="white", size=3.5) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = "Daytime/night", y = "Total claim number", title = "Total claims made during daytime and night")
```



4. What kind of weather (temperature and precipitation) is considered safer or dangerous for bus drivers?

```{r}
dh_mva_incidents <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  mutate(date_hour = format(DateOccurred, format = "%Y-%m-%d %H")) %>%
  filter(company %in% c("TDNSW", "TDM"),
         str_starts(TypeOfClaimName, "MVA"))

melbourneweather <- melbourneweather %>%
  mutate(company = "TDM",
         date_hour = format(timestamp, format = "%Y-%m-%d %H")) %>%
  rename(Temperature = `Melbourne Temperature`, Precipitation = `Melbourne Precipitation Total`)

sydneyweather <- sydneyweather %>%
  mutate(company = "TDNSW",
         date_hour = format(timestamp, format = "%Y-%m-%d %H")) %>%
  rename(Temperature = `Sydney Temperature`, Precipitation = `Sydney Precipitation Total`)

mel_syd_weather <- rbind(melbourneweather, sydneyweather)

weather_n_incidents <- mel_syd_weather %>%
  mutate(hour = hour(timestamp)) %>%
  left_join(dh_mva_incidents, by = c("company", "date_hour")) %>%
  mutate(Temperature = as.numeric(Temperature),
         Precipitation = as.numeric(Precipitation),
         rain = case_when(Precipitation >= 2.5 ~ "Yes",
                          Precipitation < 2.5 ~ "No"),
         has_incident = case_when(is.na(ClaimNumber) ~ "No",
                                         !is.na(ClaimNumber) ~ "Yes"))

weather_n_incidents %>%
  filter(rain == "Yes") %>%
  ggplot(aes(x = Precipitation, group = has_incident, fill = has_incident)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~company, nrow = 2) +
  theme_minimal() +
  theme(legend.title = element_blank()) +
  scale_fill_discrete(labels=c("Non-incident", "Incident")) +
  labs(x = "Rainfall (mm)", title = "Incident and non-incident distribution under rainy condition measured by precipitation") +
  expand_limits(x = -0.5)


```

```{r}
weather_n_incidents %>%
  filter(rain == "No") %>%
  ggplot(aes(x = Precipitation, group = has_incident, fill = has_incident)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~company, nrow = 2) +
  theme_minimal() +
  theme(legend.title = element_blank()) +
  scale_fill_discrete(labels=c("Non-incident", "Incident")) +
  labs(x = "Rainfall (mm)", title = "Incident and non-incident distribution under little/no rain condition measured by precipitation") +
  expand_limits(x = -0.2:2.4)


```

```{r}
weather_n_incidents %>%
  ggplot(aes(x = Temperature, group = has_incident, fill = has_incident)) +
  geom_density(alpha = 0.5) +
  facet_grid(~company) +
  theme_minimal() +
  theme(legend.title = element_blank()) +
  scale_fill_discrete(labels=c("Non-incident", "Incident")) +
  labs(x = "Temperature (°C)", title = "Incident and non-incident distribution measured by temperature")

```

5. Is there a relationship between drivers' driving hours within a day and the likelihood of getting into an incident?

```{r}
tmp2_when_occur <- tmp2 %>%
  filter(match_type == 2) %>%
  distinct(EmployeeID, ClaimCategoryName, DateOccurred, .keep_all = TRUE) %>%
  mutate(diff_occur_start = difftime(DateOccurred, shift_start),
         diff_occur_start = diff_occur_start/dhours(),
         hour = hour(DateOccurred),
         day_night = case_when(hour >= 19 | hour %in% c(0, 1, 2, 3, 4) ~ "Night",
                               hour < 19 ~ "Day")) %>%
  filter(str_starts(TypeOfClaimName, "MVA"))
tmp2_when_occur$diff_occur_start <- round(tmp2_when_occur$diff_occur_start, digits = 0) 

ggplot(tmp2_when_occur, aes(x = diff_occur_start)) +
  geom_histogram(aes(y = ..density..), bins = 25, alpha = 0.4) +
  geom_density() +
  facet_grid(~day_night) +
  theme_minimal() +
  labs(x = "Number of hour(s) after shift start", title = "Hour(s) that claims made after drivers' driving hours in NSW")

```

FIT a model to predict incident, understand the relationship between variables. Random forest (suggested), can discover non-linear relationship, build tree diagrams, get variable importance. e.g. given an hour, is it going to be incident or not. variables e.g. gender, hour of driving, weather, time of day.

```{r}
nswshifts_base <- nswshifts %>%
  mutate(JoinDate = as.Date(VdsTripStartTime)) %>%
  group_by(EmployeeID, JoinDate) %>%
  summarise(shift_start = min(VdsTripStartTime)-30*60,
  shift_end = max(VdsTripEndTime)+30*60)

tmp2_mva <- tmp2 %>%
  distinct(EmployeeID, ClaimCategoryName, DateOccurred, .keep_all = TRUE) %>%
  filter(match_type == 2, str_starts(TypeOfClaimName, "MVA"))
  
nswshifts_drvhour <- nswshifts_base %>%
  left_join(tmp2_mva, by = c("EmployeeID", "JoinDate", "shift_start", "shift_end")) %>%
  mutate(drive_hour = difftime(shift_end, shift_start),
         drive_hour = drive_hour/dhours(),
         start_hour = hour(shift_start))
         
nswshifts_drvhour$drive_hour <- round(nswshifts_drvhour$drive_hour, digits = 0) 

nswshifts_drvhour <- nswshifts_drvhour %>%
  inner_join(driver_info %>%
              select(EmployeeID, Gender), by = "EmployeeID") %>%
  mutate(has_incident = case_when(is.na(ClaimNumber) ~ "No",
                                         !is.na(ClaimNumber) ~ "Yes")) 
nswshifts_drvhour <- nswshifts_drvhour %>%
  select(drive_hour, start_hour, Gender, has_incident) %>%
  ungroup() %>%
  select(-EmployeeID) %>% 
  mutate(Gender = case_when(Gender == "Male" ~ 1,
                            Gender == "Female" ~ 0))



set.seed(2021)
nswshifts_drvhour <- nswshifts_drvhour %>%
  mutate(has_incident = factor(has_incident)) 
nswshifts_drvhour_split <- initial_split(nswshifts_drvhour, 2/3,
                                         strata = has_incident)
nswshifts_drvhour_tr <- training(nswshifts_drvhour_split)
nswshifts_drvhour_ts <- testing(nswshifts_drvhour_split)

nswshifts_drvhour_rf <- randomForest(has_incident~drive_hour+start_hour+Gender, data = nswshifts_drvhour_tr, importance = TRUE)

#nswshifts_drvhour_ts$Gender <- factor(nswshifts_drvhour_ts$Gender, levels = levels(nswshifts_drvhour_tr$Gender))

nswshifts_drvhour_ts_pred <- nswshifts_drvhour_ts %>%
  mutate(.pred = predict(nswshifts_drvhour_rf, nswshifts_drvhour_ts))

importance(nswshifts_drvhour_rf)


```

```{r}
# fix the original random forest dataframe
nswshifts1 <- nswshifts %>%
  rename(shift_start = VdsTripStartTime, shift_end = VdsTripEndTime) %>%
  mutate(JoinDate = as.Date(shift_start)) %>%
  select(EmployeeID, shift_start, shift_end, JoinDate)

incident1 <- incidents %>%
  drop_na(EmployeeNumber) %>%
  distinct(EmployeeID, ClaimCategoryId, DateOccurred, .keep_all = TRUE) %>%
  filter(company == "TDNSW", str_starts(TypeOfClaimName, "MVA")) %>%
  mutate(JoinDate = as.Date(DateOccurred)) %>%
  group_by(EmployeeID, JoinDate) %>%
  select(EmployeeID, DateOccurred, JoinDate)

nswshifts_lj_inc <- nswshifts1 %>%
  group_by(EmployeeID, JoinDate) %>%
  summarise(shift_start = min(shift_start)-30*60,
            shift_end = max(shift_end)+30*60) %>%
  left_join(incident1, by = c("EmployeeID", "JoinDate")) %>%
  select(EmployeeID, shift_start, shift_end, DateOccurred) %>%
  mutate(has_incident = case_when(is.na(DateOccurred) ~ "No",
                                         !is.na(DateOccurred) ~ "Yes"))

long_shifts_inc <- nswshifts_lj_inc %>%
  mutate(shift_date = as.Date(shift_start),
         shift_start_hour = hour(shift_start),
         shift_end_hour = hour(shift_end),
         Occurred_hour = hour(DateOccurred)) %>% 
  # creating list of shift hours between start and end hour & then unnesting the dataframe to make it long
  rowwise() %>%
  mutate(shift_hour_of_day = list(c(shift_start_hour:shift_end_hour))) %>%
  unnest(cols = c(shift_hour_of_day)) %>%
  mutate(shift_hour_for_driver = shift_hour_of_day - shift_start_hour) %>%
  # some further wrangling to remove unneccessary columns & convert incident hour into hourly indicator & restrict inc
  mutate(incident_indicator = case_when(
    Occurred_hour == shift_hour_of_day ~ 1,
    TRUE                               ~ 0
  )) %>%
# added in order to use difftime
  mutate(shift_start_hour = strptime(shift_start_hour, format = "%H"),
         shift_hour_of_day = strptime(shift_hour_of_day, format = "%H"),
         shift_hour_for_driver = difftime(shift_hour_of_day, shift_start_hour),
         shift_hour_for_driver = shift_hour_for_driver/dhours()) %>%
  # try to bind shift_start date with hour, but not working for shift_hour_of_day
         #shift_start_hour = strptime(paste(shift_start, shift_start_hour), format = "%Y-%m-%d %H"),
         #shift_hour_of_day = strptime(paste(shift_start, shift_hour_of_day)), format = "%Y-%m-%d %H")) %>%
  select(-shift_start, -shift_end, -DateOccurred, -Occurred_hour) 

long_shifts_inc %>%
  
```



Rain distribution can do t-test, test significance. NOTE: look up requirements for t-test.
two-sample t-test
paired t-test
```{r}
# compare precipitation between has_incident=yes and has_incident=no
rain_inc <- weather_n_incidents %>%
  select(Precipitation, has_incident) 
# has_incident = yes
summary(rain_inc %>%
          filter(has_incident == "Yes") %>%
          .$Precipitation)

summary(rain_inc %>%
          filter(has_incident == "No") %>%
          .$Precipitation)
```

```{r}
ggplot(rain_inc, aes(Precipitation)) +
        geom_histogram(fill = "white", color = "grey30") +
        facet_wrap(~has_incident) +
        scale_x_log10()
```

```{r}
wilcox.test(Precipitation ~ has_incident, data = rain_inc)
# is associated, relationship
```

Temperature: 

```{r}
temp_inc <- weather_n_incidents %>%
  select(Temperature, has_incident) 
# has_incident = yes
summary(rain_inc %>%
          filter(has_incident == "Yes") %>%
          .$Temperature)

summary(rain_inc %>%
          filter(has_incident == "No") %>%
          .$Temperature)
```

```{r}
ggplot(temp_inc, aes(Temperature)) +
        geom_histogram(fill = "white", color = "grey30") +
        facet_wrap(~has_incident) 
```

```{r}
t.test(Temperature ~ has_incident, data = temp_inc)
# the existence of significance difference
```

Comparing with rainfall, temperature is more associated with the occurrence of accidents.